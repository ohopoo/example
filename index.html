<!DOCTYPE html>
<html>
  <head>
	<title>PDF.js Learning</title>
	<link type="text/css" href="text_layer_builder.css" rel="stylesheet">
	<link type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	<style type="text/css">
		#tabletext{
			height:100vh;
			overflow-y:scroll;
		}
		li {
			display: inline;
			float: left;
			width: 100%;
		}
		html,body{height: 100%;margin: 0px;}
	</style>
  </head>
  <body>
	<script type="text/javascript" src="text_layer_builder.js"></script>
	<script type="text/javascript" src="pdf.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script>
		window.onload = function() {
			document.getElementById("convert").onclick = function fun() {
				// URL of PDF document
				var url = document.getElementById("pdfurl").value; //"success.pdf";

				// Asynchronous download PDF
				PDFJS.getDocument(url)
				  .then(function(pdf) {

					// Get div#thecanvas and cache it for later use
					var thecanvas = document.getElementById("thecanvas");
					while (thecanvas.hasChildNodes()) {
						thecanvas.removeChild(thecanvas.firstChild);
					}
					var pdftext = document.getElementById("pdftext");
					while (pdftext.hasChildNodes()) {
						pdftext.removeChild(pdftext.firstChild);
					}

					// Loop from 1 to total_number_of_pages in PDF document
					for (var i = 1; i <= pdf.numPages; i++) {

						// Get desired page
						pdf.getPage(i).then(function(page) {

						  var scale = 1.0;
						  var viewport = page.getViewport(scale);
						  var div = document.createElement("div");

						  // Set id attribute with page-#{pdf_page_number} format
						  div.setAttribute("id", "page-" + (page.pageIndex + 1));

						  // This will keep positions of child elements as per our needs
						  div.setAttribute("style", "position: relative");

						  // Append div within div#thecanvas
						  thecanvas.appendChild(div);

						  // Create a new Canvas element
						  var canvas = document.createElement("canvas");

						  // Append Canvas within div#page-#{pdf_page_number}
						  div.appendChild(canvas);

						  var context = canvas.getContext('2d');
						  canvas.height = viewport.height;
						  canvas.width = viewport.width;

						  var renderContext = {
							canvasContext: context,
							viewport: viewport
						  };

						  // Render PDF page
						  page.render(renderContext)
							  .then(function() {
								// Get text-fragments
								return page.getTextContent();
							  })
							  .then(function(textContent) {
								
								
								// find all text start points
								var xs = [], ys = [];
								textContent.items.forEach(function (item) {
									var tx = PDFJS.Util.transform(viewport.transform, item.transform);
									// avoiding tx * [0,0,1] taking x, y directly from the transform
									// console.log(item.str + ' : left ' + tx[4].toFixed(2) + ' top ' + tx[5].toFixed(2));
									var litext = document.createElement('li');
									litext.textContent  = item.str;
									litext.className = "list-group-item d-flex justify-content-between align-items-center";
									var spanleft = document.createElement('span');
									spanleft.textContent  = tx[4].toFixed(2);
									spanleft.className = "badge badge-primary badge-pill";
									var spanright = document.createElement('span');
									spanright.textContent  = tx[5].toFixed(2);
									spanright.className = "badge badge-primary badge-pill";
									litext.appendChild(spanright);
									litext.appendChild(spanleft);
									pdftext.appendChild(litext);
								});
								// var boundsOfStartPoints = [Math.min.apply(null, xs), Math.min.apply(null, ys), Math.max.apply(null, xs), Math.max.apply(null, ys)];

								// Create div which will hold text-fragments
								var textLayerDiv = document.createElement("div");

								// Set it's class to textLayer which have required CSS styles
								textLayerDiv.setAttribute("class", "textLayer");

								// Append newly created div in `div#page-#{pdf_page_number}`
								div.appendChild(textLayerDiv);

								// Create new instance of TextLayerBuilder class
								var textLayer = new TextLayerBuilder({
								  textLayerDiv: textLayerDiv, 
								  pageIndex: page.pageIndex,
								  viewport: viewport
								});

								// Set text-fragments
								textLayer.setTextContent(textContent);

								// Render text-fragments
								textLayer.render();
							  });
						});
					}
				}); 
			}
		}
  </script>
  <div class="container">
  <div class="row" style="padding-top:10px;">
	<div class="input-group">
		<input id="pdfurl" type="text" class="form-control" placeholder="Enter the PDF url">
		<div class="input-group-btn">
		  <button id="convert" class="btn btn-default" type="submit">
			<i class="glyphicon glyphicon-search"></i>
		  </button>
		</div>
	  </div>
  </div>
  <hr/>
  <div class="row">
	  <div class="panel-group">
		<div class="panel panel-primary col-md-6">
		  <div class="panel-heading">PDF Viewer</div>
		  <div class="panel-body">
			<div id="thecanvas"></div>
		  </div>
		</div>

		<div class="panel panel-success col-md-6">
		  <div class="panel-heading">PDF to TEXT</div>
		  <div class="panel-body">
		  <div id="tabletext">
			<ul id="pdftext" class="list-group">
			</ul>
			</div>
		  </div>
		</div>
	  </div>
  </div> 
  </div>
 </body>
</html>
